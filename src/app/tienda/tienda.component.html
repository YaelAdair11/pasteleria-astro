<div class="tienda-container">
  <header class="tienda-header">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="tienda-title mb-0"><i class="fas fa-store me-2"></i> Tienda en Línea</h1>
        
        <div class="d-flex align-items-center gap-3">
          <div *ngIf="loading" class="spinner-border spinner-border-sm text-light" role="status"></div>
          
          <div class="search-bar d-none d-md-block">
            <input type="text" [(ngModel)]="terminoBusqueda" (input)="filtrarProductos()" placeholder="Buscar productos..." class="form-control"/>
            <i class="fas fa-search search-icon"></i>
          </div>
          
          <div class="dropdown position-relative">
            <button *ngIf="!usuario" class="btn btn-outline-light rounded-circle p-2" (click)="abrirLogin()" title="Iniciar Sesión">
              <i class="fas fa-user"></i>
            </button>

            <button *ngIf="usuario" class="btn btn-light rounded-circle p-2" (click)="menuUsuarioAbierto = !menuUsuarioAbierto">
              <i class="fas fa-user-circle fa-lg text-dark"></i>
            </button>

            <div class="user-dropdown-menu shadow" *ngIf="menuUsuarioAbierto && usuario">
              <div class="px-3 py-2 border-bottom bg-light">
                <small class="text-muted d-block">Hola,</small>
                <strong class="text-dark text-truncate d-block" style="max-width: 150px;">{{ usuario.username || usuario.email }}</strong>
              </div>
              <button class="dropdown-item py-2" (click)="abrirPerfil()">
                <i class="fas fa-pen me-2 text-muted"></i> Personalizar Perfil
              </button>
              <button class="dropdown-item py-2 text-danger" (click)="salir()">
                <i class="fas fa-sign-out-alt me-2"></i> Cerrar Sesión
              </button>
            </div>
            
            <div *ngIf="menuUsuarioAbierto" class="fixed-overlay" (click)="menuUsuarioAbierto = false"></div>
          </div>

          <button class="btn btn-outline-light position-relative" (click)="carritoAbierto = !carritoAbierto">
            <i class="fas fa-shopping-cart"></i>
            <span *ngIf="getCantidadTotal() > 0" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">{{ getCantidadTotal() }}</span>
          </button>
          
          <button class="btn btn-outline-light d-md-none" (click)="mostrarFiltros = !mostrarFiltros"><i class="fas fa-filter"></i></button>
        </div>
      </div>

      <div class="mt-3 d-md-none">
         <input type="text" [(ngModel)]="terminoBusqueda" (input)="filtrarProductos()" placeholder="Buscar..." class="form-control w-100"/>
      </div>
    </div>
  </header>

  <div class="container-fluid mt-4">
    <div class="row g-4">
      <aside class="col-md-3 filters-sidebar-col" [class.d-none]="!mostrarFiltros" [class.d-md-block]="true">
        <div class="filters-card">
          <h5>Filtros</h5>
           <div class="filter-section">
             <h6>Categorías</h6>
             <div class="category-list">
               <button class="category-btn" [class.active]="categoriaSeleccionada === 'todos'" (click)="categoriaSeleccionada = 'todos'; filtrarProductos()">Todos</button>
               <button *ngFor="let categoria of categorias" class="category-btn" [class.active]="categoriaSeleccionada === categoria.id" (click)="categoriaSeleccionada = categoria.id; filtrarProductos()">{{ categoria.nombre }}</button>
             </div>
          </div>
          <div class="filter-section">
             <h6>Precio</h6>
             <div class="price-range">
               <label>Mín: ${{ precioMin }}</label> <input type="range" [(ngModel)]="precioMin" min="0" max="5000" step="50" (change)="filtrarProductos()" class="form-range" />
               <label>Máx: ${{ precioMax }}</label> <input type="range" [(ngModel)]="precioMax" min="0" max="5000" step="50" (change)="filtrarProductos()" class="form-range" />
             </div>
          </div>
          <div class="filter-section">
            <h6>Ordenar</h6>
            <select [(ngModel)]="ordenSeleccionado" (change)="ordenarProductos()" class="form-select">
              <option value="nombre">Nombre A-Z</option> <option value="precio-asc">Precio: Menor a Mayor</option> <option value="precio-desc">Precio: Mayor a Menor</option> <option value="stock-desc">Mayor Stock</option>
            </select>
          </div>
        </div>
      </aside>

      <main class="col-md-9">
          <div class="products-header mb-4"><h4>{{ productosFiltrados.length }} productos encontrados</h4></div>
          <div class="row" *ngIf="!loading">
            <div *ngFor="let producto of productosFiltrados" class="col-xl-3 col-lg-4 col-md-6 mb-4">
               <div class="product-card">
                  <div class="product-badges"><span *ngIf="producto.destacado" class="badge bg-warning">Destacado</span> <span *ngIf="producto.stock <= 5" class="badge bg-danger">¡Últimas unidades!</span></div>
                  <div class="product-image">
                    <img [src]="producto.imagen || '/images/placeholder.jpg'" [alt]="producto.nombre" (error)="producto.imagen='/images/placeholder.jpg'">
                    <div class="product-overlay">
                       <button class="btn btn-primary btn-sm" (click)="agregarAlCarrito(producto)" [disabled]="producto.stock <= 0"><i class="fas fa-cart-plus"></i> {{ producto.stock > 0 ? 'Agregar' : 'Sin Stock' }}</button>
                    </div>
                  </div>
                  <div class="product-info">
                    <h6 class="product-category">{{ getNombreCategoria(producto) }}</h6>
                    <h5 class="product-title">{{ producto.nombre }}</h5>
                    <div class="product-price"><span class="current-price">${{ producto.precio }}</span></div>
                  </div>
               </div>
            </div>
          </div>
          <div *ngIf="productosFiltrados.length === 0 && !loading" class="text-center py-5">
             <i class="fas fa-search fa-3x text-muted mb-3"></i><h4>No se encontraron productos</h4><p>Intenta con otros filtros</p>
          </div>
      </main>
    </div>
  </div>

  <div class="cart-sidebar" [class.active]="carritoAbierto">
     <div [ngSwitch]="checkoutStep" class="h-100 d-flex flex-column">
        <div *ngSwitchCase="'cart'" class="d-flex flex-column h-100">
            <div class="cart-header"><h4>Tu Carrito</h4><button class="btn-close" (click)="carritoAbierto = false"></button></div>
            <div class="cart-content">
               <div *ngFor="let item of carrito; let i = index" class="cart-item">
                  <img [src]="item.producto.imagen" (error)="item.producto.imagen='/images/placeholder.jpg'">
                  <div class="item-details"><h6>{{item.producto.nombre}}</h6><p>${{item.producto.precio}}</p><div class="quantity-controls"><button (click)="actualizarCantidad(i, item.cantidad - 1)">-</button><span>{{item.cantidad}}</span><button (click)="actualizarCantidad(i, item.cantidad + 1)">+</button></div></div>
                  <div class="item-total"><strong>${{item.producto.precio*item.cantidad}}</strong><button class="btn btn-link text-danger" (click)="eliminarDelCarrito(i)"><i class="fas fa-trash"></i></button></div>
               </div>
            </div>
            <div class="cart-footer">
               <div class="cart-total"><strong>Total: ${{getTotalCarrito()}}</strong></div>
               <button class="btn btn-primary w-100" (click)="iniciarCheckout()">Proceder al Pago</button>
            </div>
        </div>
        <div *ngSwitchCase="'shipping'" class="d-flex flex-column h-100">
           <div class="cart-header checkout-header"><button class="btn btn-link" (click)="volverA('cart')">Volver</button></div>
           <div class="cart-content checkout-view">
              <h5>Envío</h5>
              <form #shippingForm="ngForm"><input type="text" placeholder="Nombre" [(ngModel)]="shippingInfo.nombre" name="nombre" class="form-control mb-2" required><input type="email" placeholder="Email" [(ngModel)]="shippingInfo.email" name="email" class="form-control mb-2" required><input type="text" placeholder="Dirección" [(ngModel)]="shippingInfo.direccion" name="direccion" class="form-control mb-2" required></form>
           </div>
           <div class="cart-footer"><button class="btn btn-primary w-100" (click)="irAPago()" [disabled]="!shippingForm.valid">Ir a Pagar</button></div>
        </div>
        <div *ngSwitchCase="'payment'" class="d-flex flex-column h-100">
           <div class="cart-header checkout-header"><button class="btn btn-link" (click)="volverA('shipping')">Volver</button></div>
           <div class="cart-content checkout-view"><h5>Resumen</h5><div class="checkout-summary"><h6>Total: ${{getTotalCarrito()}}</h6></div></div>
           <div class="cart-footer"><button class="btn btn-primary w-100" (click)="realizarCompra()" [disabled]="loading">{{ loading ? 'Procesando...' : 'Pagar' }}</button></div>
        </div>
        <div *ngSwitchCase="'success'" class="d-flex flex-column h-100">
           <div class="cart-content checkout-view text-center"><i class="fas fa-check-circle fa-3x text-success"></i><h5>¡Éxito!</h5></div>
           <div class="cart-footer"><button class="btn btn-primary w-100" (click)="finalizarYVolver()">Volver a la tienda</button></div>
        </div>
     </div>
  </div>
  <div class="cart-overlay" [class.active]="carritoAbierto" (click)="carritoAbierto = false"></div>

  <div class="auth-overlay" *ngIf="mostrarAuthModal">
    <div class="auth-card">
      <button class="btn-close position-absolute top-0 end-0 m-3" (click)="cerrarAuth()"></button>
      <div class="text-center mb-4">
        <i class="fas fa-user-circle fa-3x text-primary mb-2"></i>
        <h4>{{ esRegistro ? 'Crear Cuenta' : 'Iniciar Sesión' }}</h4>
        <p class="text-muted small">{{ esRegistro ? 'Regístrate con tu correo' : 'Ingresa tu correo' }}</p>
      </div>
      <div *ngIf="authError" class="alert alert-danger py-2 small">{{ authError }}</div>
      <form (ngSubmit)="procesarAuth()">
        <div class="mb-3"><input type="text" class="form-control" placeholder="Email" [(ngModel)]="authData.email" name="email" required></div>
        <div class="mb-4"><div class="input-group"><input [type]="mostrarPassword ? 'text' : 'password'" class="form-control border-end-0" placeholder="Contraseña" [(ngModel)]="authData.password" name="password" required><button class="btn btn-outline-secondary border-start-0 bg-light text-muted" type="button" (click)="mostrarPassword = !mostrarPassword"><i class="fas" [ngClass]="mostrarPassword ? 'fa-eye-slash' : 'fa-eye'"></i></button></div></div>
        <button type="submit" class="btn btn-primary w-100 mb-3" [disabled]="authLoading">{{ authLoading ? 'Procesando...' : (esRegistro ? 'Registrarse' : 'Entrar') }}</button>
        <div class="text-center"><button type="button" class="btn btn-link btn-sm text-decoration-none" (click)="esRegistro = !esRegistro">{{ esRegistro ? '¿Ya tienes cuenta? Inicia sesión' : '¿No tienes cuenta? Regístrate' }}</button></div>
      </form>
    </div>
  </div>

  <div class="auth-overlay" *ngIf="mostrarPerfilModal">
    <div class="auth-card">
      <button class="btn-close position-absolute top-0 end-0 m-3" (click)="cerrarPerfil()"></button>
      
      <div class="text-center mb-4">
        <i class="fas fa-user-edit fa-3x text-dark mb-2"></i>
        <h4>Personalizar Perfil</h4>
        <p class="text-muted small">Actualiza como te verán los demás</p>
      </div>

      <form (ngSubmit)="guardarPerfil()">
        <div class="mb-3">
          <label class="form-label small text-muted">Nombre de Usuario</label>
          <input type="text" class="form-control" [(ngModel)]="perfilData.username" name="editUsername" required placeholder="Escribe tu nombre">
        </div>
        
        <button type="submit" class="btn btn-dark w-100 mb-3" [disabled]="perfilLoading">
          {{ perfilLoading ? 'Guardando...' : 'Guardar Cambios' }}
        </button>

        <div class="text-center">
           <button type="button" class="btn btn-link btn-sm text-secondary text-decoration-none" (click)="cerrarPerfil()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

</div>