---
import '../../styles/panel.css'; // Aseg√∫rate que la ruta al CSS sea correcta

// --- NUEVO GUARDI√ÅN DE SUPABASE con USERNAME (Versi√≥n Cajero) ---
const { data: { user } } = await Astro.locals.supabase.auth.getUser();

if (!user) {
  return Astro.redirect('/staff-login?error=Debes iniciar sesi√≥n'); // Redirige al login de staff
}

const { data: profile, error: profileError } = await Astro.locals.supabase
  .from('profiles')
  .select('rol, username')
  .eq('id', user.id)
  .single();

// ¬°CAMBIO AQU√ç! Verificar rol 'usuario' (cajero)
if (profileError || !profile || profile.rol !== 'usuario') { 
  console.error("Error de autorizaci√≥n Cajero:", profileError || 'Perfil no encontrado o rol incorrecto');
  await Astro.locals.supabase.auth.signOut();
  return Astro.redirect('/staff-login?error=No autorizado'); // Redirige al login de staff
}

const nombreUsuario = profile.username || user.email || 'Cajero'; // Fallback final
---

<!--El resto de tu archivo HTML y <script> va aqu√≠ abajo -->
 <html lang="es">
 <head>
   {/* ... tu <head> ... */}
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Punto de Venta - Usuario</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
 </head>
 <body>
   {/* ... tu <div class="sidebar"> ... */}
    <div class="sidebar" id="sidebar">
      {/* ... contenido del sidebar ... */}
       <div class="logo">
         <i class='bx bx-cart-alt'></i>
         <span>Punto de Venta</span>
       </div>
       <ul class="nav-list">
         <li><a href="#"><i class='bx bx-home'></i><span>Inicio</span></a></li>
         <li><a href="#"><i class='bx bx-receipt'></i><span>Registrar Venta</span></a></li>
         <li><a href="#"><i class='bx bx-package'></i><span>Productos</span></a></li>
         <li><a href="#"><i class='bx bx-bar-chart-alt'></i><span>Reportes</span></a></li>
       </ul>
       <button id="logoutBtn" class="logout"><i class='bx bx-log-out'></i><span>Cerrar Sesi√≥n</span></button>
    </div>

   <section class="main-content">
      <header>
         <i class='bx bx-menu' id="menuToggle"></i>
         <h2>Panel de Ventas</h2>
      </header>

      <div class="content">
        {/* ACTUALIZA EL SALUDO AQU√ç */}
        <h3 id="bienvenida">Bienvenido, {nombreUsuario} üíº</h3>
        <p>Desde aqu√≠ podr√°s registrar ventas y consultar productos.</p>
      </div>
   </section>

   <!--tu <script> para el men√∫ y logout -->
   {/* (Aseg√∫rate que el script que ajustamos antes est√© aqu√≠) */}
     <script>
       function setupDashboard() {
         const sidebar = document.getElementById('sidebar');
         const menuToggle = document.getElementById('menuToggle');
         if (menuToggle && sidebar) {
           menuToggle.addEventListener('click', () => {
             sidebar.classList.toggle('collapsed');
           });
         }
         const logoutBtn = document.getElementById('logoutBtn');
         if (logoutBtn) {
           logoutBtn.addEventListener('click', () => {
             window.location.href = '/api/auth/logout';
           });
         }
       }
       setupDashboard();
       document.addEventListener('astro:page-load', setupDashboard);
     </script>
 </body>
 </html>