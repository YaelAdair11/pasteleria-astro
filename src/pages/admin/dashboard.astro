---
import '../../styles/panel.css';

// ‚úÖ 1. Verificar sesi√≥n del usuario DESDE EL SERVIDOR
const { data: { user } } = await Astro.locals.supabase.auth.getUser();

// Si no hay sesi√≥n activa ‚Üí redirigir
if (!user) {
  return Astro.redirect('/staff-login?error=Debes iniciar sesi√≥n');
}

// ‚úÖ 2. Buscar el perfil del usuario (rol + username)
const { data: profile, error: profileError } = await Astro.locals.supabase
  .from('perfiles')
  .select('rol, username')
  .eq('id', user.id)
  .single();

// Si hay error o el usuario no es admin ‚Üí expulsar
if (profileError || !profile || profile.rol !== 'admin') {
  console.error("Error de autorizaci√≥n Admin:", profileError || 'Perfil no encontrado o rol incorrecto');
  await Astro.locals.supabase.auth.signOut();
  return Astro.redirect('/staff-login?error=No autorizado');
}

// ‚úÖ 3. Si todo bien, definir nombre de saludo
const nombreUsuario = profile.username || user.email || 'Administrador';
---

<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punto de Venta - Admin</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
</head>
<body>
  <div class="sidebar" id="sidebar">
    <div class="logo">
      <i class='bx bx-store-alt'></i>
      <span>Punto de Venta</span>
    </div>
    <ul class="nav-list">
      <li><a href="#"><i class='bx bx-home'></i><span>Inicio</span></a></li>
      <li><a href="#"><i class='bx bx-user'></i><span>Empleados</span></a></li>
      <li><a href="#"><i class='bx bx-package'></i><span>Inventario</span></a></li>
      <li><a href="#"><i class='bx bx-cart'></i><span>Ventas</span></a></li>
      <li><a href="#"><i class='bx bx-bar-chart-alt'></i><span>Reportes</span></a></li>
    </ul>
    <button id="logoutBtn" class="logout"><i class='bx bx-log-out'></i><span>Cerrar Sesi√≥n</span></button>
  </div>

  <section class="main-content">
    <header>
      <i class='bx bx-menu' id="menuToggle"></i>
      <h2>Panel de Administraci√≥n</h2>
    </header>

    <div class="content">
      <p>Bienvenido, <strong>{nombreUsuario}</strong>. Selecciona una opci√≥n del men√∫.</p>
    </div>
  </section>

  <script is:inline type="module">
    import { supabase } from '/src/lib/supabase';

    function setupDashboard() {
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    // ... (resto de tu funci√≥n setupDashboard sin cambios) ...
    const logoutBtn = document.getElementById('logoutBtn');
    // ... (resto de tu funci√≥n setupDashboard sin cambios) ...
    }
    setupDashboard();
    document.addEventListener('astro:page-load', setupDashboard);

    // üîπ Bot√≥n de Cerrar Sesi√≥n
    const logoutBtn = document.getElementById('logoutBtn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = '/staff-login';
      });
    }

    // üîπ L√≥gica del men√∫ lateral
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    if (menuToggle && sidebar) {
      menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
      });
    }
  </script>
</body>
</html>
